/* project/static/css/style.css */

:root {
    --bg-color: #121212;
    --card-color: #1e1e1e;
    --text-color: #e5e5e5;
    --border-color: #2c2c2c;
    --placeholder-color: #444;

    --awesome-color: #4CAF50;
    --great-color: #8BC34A;
    --good-color: #CDDC39;
    --okay-color: #FFC107;
    --bad-color: #FF9800;
    --garbage-color: #f44336;

    --movie-accent: #007BFF;
    --tv-accent: #28a745;
    --album-accent: #dc3545;
    --single-accent: #ffc107;
    --album-track-accent: #9c27b0; /* NEW: Purple for album tracks */

    --movie-rgb: 0, 123, 255;
    --tv-rgb: 40, 167, 69;
    --album-rgb: 220, 53, 69;
    --single-rgb: 255, 193, 7;
    --album-track-rgb: 156, 39, 176; /* NEW: Purple RGB */
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 20px;
}

.container { max-width: 1200px; margin: 0 auto; }
.banner { height: 350px; background-size: cover; border-radius: 12px; margin-bottom: 20px; background-color: var(--placeholder-color); }

.header-card {
    background-color: var(--card-color);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-top: -80px;
    position: relative;
    z-index: 2;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border-top-width: 4px;
    border-top-style: solid;
    border-top-color: transparent;
}

.header-card.movie-border { border-top-color: var(--movie-accent); }
.header-card.tv_show-border { border-top-color: var(--tv-accent); }
.header-card.album-border { border-top-color: var(--album-accent); }
.header-card.single-border { border-top-color: var(--single-accent); }

.header-section { display: flex; gap: 30px; margin-bottom: 0; }
.poster { width: 200px; }
.poster img, .poster .placeholder { width: 100%; height: auto; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 12px; background-color: var(--placeholder-color); display: flex; justify-content: center; align-items: center; font-size: 5rem; }
.poster-square { width: 300px; }
.poster-square img, .poster-square .placeholder { aspect-ratio: 1 / 1; }

.title-info h1 { margin: 0 0 5px 0; font-size: 2.5rem; }
.title-info .creator { font-size: 1.2rem; color: #ccc; margin-top: 0; margin-bottom: 10px; font-weight: bold; }
.title-info .years { color: #aaa; margin-bottom: 15px; }
.admin-actions { margin-top: 20px; }
.score-display-container { margin-top: 15px; margin-bottom: 5px; }
.score-label { font-size: 1rem; color: #aaa; margin-bottom: 5px; }
.overall-score-box { display: inline-block; padding: 10px 25px; font-size: 2.5rem; font-weight: bold; border-radius: 10px; color: #111; min-width: 60px; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
.calculated-avg { margin-top: 10px; color: #aaa; font-size: 1rem; }

.tag-badge-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; margin-bottom: 10px; }
.tag-badge { background-color: var(--border-color); color: #ccc; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }

.ratings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; margin-top: 20px; }
.rating-item { width: 60px; height: 40px; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #111; cursor: pointer; position: relative; transition: transform 0.2s ease-in-out; }
.rating-item:hover { transform: scale(1.1); }
.rating-item[data-title]:hover::after { content: attr(data-title); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background-color: #111; color: white; padding: 5px 10px; border-radius: 4px; white-space: nowrap; z-index: 10; font-size: 0.8rem; }

.awesome { background-color: var(--awesome-color); } .great { background-color: var(--great-color); } .good { background-color: var(--good-color); } .okay { background-color: var(--okay-color); } .bad { background-color: var(--bad-color); } .garbage { background-color: var(--garbage-color); }

.season-header { margin-top: 30px; margin-bottom: 15px; font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; display: flex; justify-content: space-between; align-items: baseline; }
.album-header { margin-top: 30px; font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
.season-header h2 { margin: 0; font-size: 1.5rem; }
.season-details { display: flex; align-items: baseline; gap: 15px; }
.season-year { font-size: 1rem; color: #aaa; }
.season-score-box { font-weight: bold; padding: 4px 8px; border-radius: 5px; color: #111; font-size: 1.1rem; }
.season-avg { font-size: 0.9rem; color: #888; font-style: italic; }

.login-container { display: flex; align-items: center; justify-content: center; min-height: 70vh; }
.login-card { background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 32px; max-width: 400px; width: 100%; text-align: center; }
.login-icon { color: #666; width: 48px; height: 48px; margin: 0 auto 16px auto; }
.login-card h2 { margin-top: 0; }
.login-form { text-align: left; }
.login-form .form-group { margin-bottom: 20px; }

nav { display: flex; justify-content: space-between; align-items: center; background-color: var(--card-color); padding: 10px 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); }
nav a { color: var(--text-color); text-decoration: none; padding: 8px 12px; border-radius: 8px; transition: background-color 0.2s; }
nav a:hover { background-color: #333; }

form { background-color: var(--card-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; }
.form-group input, .form-group select { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 8px; transition: all 0.2s ease-in-out; }
.form-group input::placeholder { color: #666; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: var(--movie-accent); box-shadow: 0 0 0 3px rgba(var(--movie-rgb), 0.3); }

.tag-group { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
.tag-group h4 { margin-top: 0; margin-bottom: 10px; color: #aaa; }
.tag-checkbox { display: inline-flex; align-items: center; cursor: pointer; margin-right: 15px; margin-bottom: 5px; }
.tag-checkbox input[type="checkbox"] { margin-right: 5px; }

.season-block { background: #333; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
.season-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
.episode-row { display: flex; gap: 5px; margin-top: 5px; }
.track-row { display: flex; gap: 5px; margin-top: 5px; }

button, .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; font-weight: bold; transition: filter 0.2s; }
button:hover, .btn:hover { filter: brightness(1.15); }

.btn-primary { background-color: var(--movie-accent); color: white; }
.btn-danger { background-color: var(--garbage-color); color: white; }
.btn-full { width: 100%; padding-top: 12px; padding-bottom: 12px; font-size: 1.1rem; }

.flash-message { padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid transparent; }
.flash-message.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
.flash-message.danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }

.filter-form { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 10px; background-color: var(--card-color); padding: 15px; border-radius: 12px; align-items: flex-end; border: 1px solid var(--border-color); }
.filter-form .form-group { margin-bottom: 0; }
.filter-form select { width: 200px; }

.legend { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; padding-left: 5px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
.legend-color-box { width: 15px; height: 15px; border-radius: 50%; display: inline-block; }
.legend-movie { background-color: var(--movie-accent); } 
.legend-tv { background-color: var(--tv-accent); } 
.legend-album { background-color: var(--album-accent); } 
.legend-single { background-color: var(--single-accent); }
.legend-album-track { background-color: var(--album-track-accent); } /* NEW */

.media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
.media-card { background-color: var(--card-color); border-radius: 12px; text-decoration: none; color: var(--text-color); overflow: hidden; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out; }
.media-card:hover { transform: scale(1.04); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
.media-card:hover.movie-border { border-color: var(--movie-accent); } 
.media-card:hover.tv-border { border-color: var(--tv-accent); } 
.media-card:hover.album-border { border-color: var(--album-accent); } 
.media-card:hover.single-border { border-color: var(--single-accent); }
.media-card:hover.album_track-border { border-color: var(--album-track-accent); } /* NEW */

.media-card-poster img, .media-card-poster .placeholder { width: 100%; display: block; background-color: var(--placeholder-color); aspect-ratio: 2 / 3; object-fit: cover; }
.media-card-poster .placeholder { display: flex; justify-content: center; align-items: center; font-size: 4rem; color: #222; }
.media-card-square .media-card-poster img, .media-card-square .media-card-poster .placeholder { aspect-ratio: 1 / 1; }

.media-card-info { padding: 10px; }
.media-card-info.movie-type { background: linear-gradient(180deg, rgba(var(--movie-rgb), 0.35) 0%, var(--card-color) 100%); }
.media-card-info.tv-type { background: linear-gradient(180deg, rgba(var(--tv-rgb), 0.35) 0%, var(--card-color) 100%); }
.media-card-info.album-type { background: linear-gradient(180deg, rgba(var(--album-rgb), 0.35) 0%, var(--card-color) 100%); }
.media-card-info.single-type { background: linear-gradient(180deg, rgba(var(--single-rgb), 0.45) 0%, var(--card-color) 100%); }
.media-card-info.album_track-type { background: linear-gradient(180deg, rgba(var(--album-track-rgb), 0.45) 0%, var(--card-color) 100%); } /* NEW */

.media-card-info h3 { font-size: 1rem; margin: 0 0 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.media-card-info .creator { font-size: 0.8rem; color: #aaa; margin: 0 0 5px 0; }
.media-card-info .score { font-size: 0.9rem; font-weight: bold; margin: 0; }
.media-card-year { font-size: 0.8rem; color: #888; margin: 0 0 5px 0; }```

### 2. Update the Routes (`project/routes.py`)

Next, we'll modify the `index` route to assign a unique type, `album_track`, to songs that come from an album. This will allow our template to pick up the new CSS styles.

**Replace the entire content of `project/routes.py` with the following code:**

```python
# project/routes.py

import os
from flask import Blueprint, render_template, redirect, url_for, request, flash
from flask_login import login_user, logout_user, login_required, current_user
from werkzeug.security import check_password_hash
from werkzeug.utils import secure_filename
from . import db
from .models import User, Media, Season, Episode, Track, Tag, media_tags
from .forms import LoginForm, MediaForm

main = Blueprint('main', __name__)

def get_rating_class(rating):
    if rating is None: return "garbage"
    if rating >= 9.0: return "awesome"
    if rating >= 8.0: return "great"
    if rating >= 7.0: return "good"
    if rating >= 6.0: return "okay"
    if rating >= 5.0: return "bad"
    return "garbage"

@main.route('/')
def index():
    sort_by = request.args.get('sort', 'title_asc')
    filter_type = request.args.get('filter', 'all')
    tag_filter = request.args.get('tag', 'all')

    all_tags = Tag.query.order_by(Tag.name).all()

    if filter_type == 'songs':
        # --- NEW LOGIC FOR 'SONGS' FILTER ---
        all_songs = []
        
        # 1. Get all 'single' media type
        singles_query = Media.query.filter_by(media_type='single')
        if tag_filter != 'all':
            try:
                tag_id = int(tag_filter)
                media_ids_with_tag = db.session.query(media_tags.c.media_id).filter_by(tag_id=tag_id)
                singles_query = singles_query.filter(Media.id.in_([item[0] for item in media_ids_with_tag]))
            except (ValueError, TypeError):
                pass
        
        for s in singles_query.all():
            all_songs.append({
                'id': s.id,
                'title': s.title,
                'creator': s.creator,
                'years': s.years,
                'poster_img': s.poster_img,
                'overall_score': s.overall_score if s.overall_score is not None else 0.0,
                'media_type': 'single'
            })

        # 2. Get all tracks from 'album' media type
        albums_query = Media.query.filter_by(media_type='album')
        if tag_filter != 'all':
            try:
                tag_id = int(tag_filter)
                media_ids_with_tag = db.session.query(media_tags.c.media_id).filter_by(tag_id=tag_id)
                albums_query = albums_query.filter(Media.id.in_([item[0] for item in media_ids_with_tag]))
            except (ValueError, TypeError):
                pass

        for album in albums_query.all():
            for track in album.tracks:
                all_songs.append({
                    'id': album.id,
                    'title': track.title,
                    'creator': album.creator,
                    'years': album.years,
                    'poster_img': album.poster_img,
                    'overall_score': track.rating if track.rating is not None else 0.0,
                    'media_type': 'album_track' # UPDATED: Use a new type for styling
                })
        
        all_media_list = all_songs

        def get_year_for_sort_song(song_item):
            if not song_item['years']: return 0
            try: return int(song_item['years'][:4])
            except (ValueError, IndexError): return 0

        if sort_by == 'score_desc':
            all_media_list.sort(key=lambda m: m['overall_score'], reverse=True)
        elif sort_by == 'score_asc':
            all_media_list.sort(key=lambda m: m['overall_score'])
        elif sort_by == 'year_desc':
            all_media_list.sort(key=get_year_for_sort_song, reverse=True)
        elif sort_by == 'year_asc':
            all_media_list.sort(key=get_year_for_sort_song)
        else: # title_asc
            all_media_list.sort(key=lambda m: m['title'].lower())

    else:
        # --- ORIGINAL LOGIC FOR OTHER FILTERS ---
        query = Media.query
        if filter_type != 'all':
            query = query.filter(Media.media_type == filter_type)

        if tag_filter != 'all':
            try:
                tag_id = int(tag_filter)
                media_ids_with_tag = db.session.query(media_tags.c.media_id).filter_by(tag_id=tag_id)
                query = query.filter(Media.id.in_([item[0] for item in media_ids_with_tag]))
            except (ValueError, TypeError):
                pass
        
        all_media_list = query.all()

        def get_year_for_sort(media_item):
            if not media_item.years: return 0
            try: return int(media_item.years[:4])
            except (ValueError, IndexError): return 0

        if sort_by == 'score_desc':
            all_media_list.sort(key=lambda m: m.overall_score, reverse=True)
        elif sort_by == 'score_asc':
            all_media_list.sort(key=lambda m: m.overall_score)
        elif sort_by == 'year_desc':
            all_media_list.sort(key=get_year_for_sort, reverse=True)
        elif sort_by == 'year_asc':
            all_media_list.sort(key=get_year_for_sort)
        else:
            all_media_list.sort(key=lambda m: m.title.lower())

    return render_template('index.html', 
                           all_media=all_media_list, 
                           all_tags=all_tags,
                           current_sort=sort_by, 
                           current_filter=filter_type,
                           current_tag=tag_filter)


@main.route('/media/<int:media_id>')
def media_page(media_id):
    media_item = Media.query.get_or_404(media_id)
    return render_template('media_page.html', media=media_item, get_rating_class=get_rating_class)

@main.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    form = LoginForm()
    if form.validate_on_submit():
        user = User.query.filter_by(username=form.username.data).first()
        if user and check_password_hash(user.password, form.password.data):
            login_user(user)
            return redirect(url_for('main.index'))
        else:
            flash('Login Unsuccessful. Please check username and password', 'danger')
    return render_template('login.html', form=form)

@main.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('main.index'))

def save_file(file_storage):
    from flask import current_app
    filename = secure_filename(file_storage.filename)
    file_path = os.path.join(current_app.config['UPLOAD_FOLDER'], filename)
    file_storage.save(file_path)
    return filename

@main.route('/edit_media/<int:media_id>', methods=['GET', 'POST'])
@login_required
def edit_media(media_id):
    media = Media.query.get_or_404(media_id)
    form = MediaForm(obj=media)
    all_tags = Tag.query.order_by(Tag.name).all()
    media_tag_ids = [tag.id for tag in media.tags]

    if form.validate_on_submit():
        media.media_type = form.media_type.data
        media.title = form.title.data
        media.creator = form.creator.data
        media.years = form.years.data
        media.official_rating = form.official_rating.data

        if form.poster_img.data:
            media.poster_img = save_file(form.poster_img.data)
        if form.banner_img.data:
            media.banner_img = save_file(form.banner_img.data)

        delete_stmt = media_tags.delete().where(media_tags.c.media_id == media.id)
        db.session.execute(delete_stmt)

        selected_tag_ids = request.form.getlist('tags', type=int)
        for tag_id in selected_tag_ids:
            insert_stmt = media_tags.insert().values(media_id=media.id, tag_id=tag_id)
            db.session.execute(insert_stmt)

        if media.media_type == 'tv_show':
            for track in media.tracks: db.session.delete(track)
        elif media.media_type == 'album':
            for season in media.seasons: db.session.delete(season)
        
        db.session.commit()
        
        if media.media_type == 'tv_show':
            Season.query.filter_by(media_id=media.id).delete()
            for s_key, s_val in request.form.items():
                if s_key.startswith('season_number_'):
                    s_idx = s_key.split('_')[-1]
                    
                    season_rating_str = request.form.get(f'season_rating_{s_idx}', '')
                    season_rating = float(season_rating_str) if season_rating_str else None
                    season_year = request.form.get(f'season_year_{s_idx}', '')

                    new_season = Season(
                        season_number=int(s_val), 
                        rating=season_rating, 
                        year=season_year,
                        media_id=media.id
                    )
                    db.session.add(new_season)
                    db.session.flush()

                    for e_key, e_val in request.form.items():
                        if e_key.startswith(f'ep_number_{s_idx}_'):
                            e_idx = e_key.split('_')[-1]
                            ep_title = request.form.get(f'ep_title_{s_idx}_{e_idx}', '')
                            ep_rating_str = request.form.get(f'ep_rating_{s_idx}_{e_idx}', '')
                            ep_rating = float(ep_rating_str) if ep_rating_str else None
                            new_ep = Episode(episode_number=int(e_val), title=ep_title, rating=ep_rating, season_id=new_season.id)
                            db.session.add(new_ep)
        
        elif media.media_type == 'album':
            Track.query.filter_by(media_id=media.id).delete()
            for t_key, t_val in request.form.items():
                if t_key.startswith('track_number_'):
                    t_idx = t_key.split('_')[-1]
                    track_title = request.form.get(f'track_title_{t_idx}', '')
                    track_rating_str = request.form.get(f'track_rating_{t_idx}', '')
                    track_rating = float(track_rating_str) if track_rating_str else None
                    new_track = Track(track_number=int(t_val), title=track_title, rating=track_rating, media_id=media.id)
                    db.session.add(new_track)

        db.session.commit()
        flash('Media updated!', 'success')
        return redirect(url_for('main.media_page', media_id=media.id))
        
    return render_template('edit_media.html', 
                           form=form, 
                           media=media, 
                           all_tags=all_tags,
                           media_tag_ids=media_tag_ids)

@main.route('/add_media', methods=['GET', 'POST'])
@login_required
def add_media():
    form = MediaForm()
    if form.validate_on_submit():
        new_media = Media(
            media_type=form.media_type.data,
            title=form.title.data,
            creator=form.creator.data,
            years=form.years.data,
            official_rating=form.official_rating.data
        )
        if form.poster_img.data:
            new_media.poster_img = save_file(form.poster_img.data)
        if form.banner_img.data:
            new_media.banner_img = save_file(form.banner_img.data)
        
        db.session.add(new_media)
        db.session.commit()
        flash('New media created. You can now add episodes/tracks and tags.', 'success')
        return redirect(url_for('main.edit_media', media_id=new_media.id))
    
    all_tags = Tag.query.order_by(Tag.name).all()
    return render_template('edit_media.html', form=form, media=None, all_tags=all_tags, media_tag_ids=[])

@main.route('/delete_media/<int:media_id>', methods=['POST'])
@login_required
def delete_media(media_id):
    media_to_delete = Media.query.get_or_404(media_id)
    
    delete_stmt = media_tags.delete().where(media_tags.c.media_id == media_id)
    db.session.execute(delete_stmt)
    
    db.session.delete(media_to_delete)
    db.session.commit()
    flash('Media has been deleted.', 'success')
    return redirect(url_for('main.index'))
