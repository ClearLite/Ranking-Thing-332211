{% extends "base.html" %}

{% block title %}{{ 'Edit ' + media.title if media else 'Add New Media' }}{% endblock %}

{% block content %}
    <form method="POST" enctype="multipart/form-data" id="media-form">
        {{ form.hidden_tag() }}
        <h2>{{ 'Edit ' + media.title if media else 'Add New Media' }}</h2>
        
        <div class="form-group">
            {{ form.media_type.label }} {{ form.media_type() }}
        </div>
        <div class="form-group">
            {{ form.title.label }} {{ form.title() }}
        </div>
        <div class="form-group">
            {{ form.creator.label }} {{ form.creator() }}
        </div>
        <div class="form-group">
            {{ form.years.label }} {{ form.years() }}
        </div>
        <div class="form-group">
            {{ form.poster_img.label }} {{ form.poster_img() }}
        </div>
        <div class="form-group">
            {{ form.banner_img.label }} {{ form.banner_img() }}
        </div>
        <div class="form-group">
            {{ form.official_rating.label }} {{ form.official_rating() }}
        </div>

        <hr>
        
        <div class="form-group">
            <label>Genres / Tags</label>
            <div id="cinematic-tags" class="tag-group">
                <h4>Cinematic</h4>
                {% for tag in all_tags if tag.category == 'cinematic' %}
                    <label class="tag-checkbox">
                        <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in media_tag_ids %}checked{% endif %}>
                        {{ tag.name }}
                    </label>
                {% endfor %}
            </div>
            <div id="musical-tags" class="tag-group">
                <h4>Musical</h4>
                {% for tag in all_tags if tag.category == 'musical' %}
                    <label class="tag-checkbox">
                        <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in media_tag_ids %}checked{% endif %}>
                        {{ tag.name }}
                    </label>
                {% endfor %}
            </div>
        </div>

        <div id="tv-show-fields">
            <h3>Seasons & Episodes</h3>
            <div id="seasons-container">
                {% if media and media.media_type == 'tv_show' %}
                    {% for season in media.seasons %}
                    <div class="season-block">
                        <div class="season-inputs">
                            Season #: <input type="number" name="season_number_{{ loop.index }}" value="{{ season.season_number }}" style="width: 60px;">
                            Year: <input type="text" name="season_year_{{ loop.index }}" value="{{ season.year or '' }}" style="width: 80px;" placeholder="YYYY">
                            Rating: <input type="text" name="season_rating_{{ loop.index }}" value="{{ season.rating or '' }}" style="width: 60px;" placeholder="0-10">
                            <button type="button" class="btn-danger" style="margin-left: auto; padding: 5px 10px;" onclick="removeElement(this, 'season')">Delete Season</button>
                        </div>
                        <div class="episodes-container">
                            {% set outer_loop_index = loop.index %}
                            {% for episode in season.episodes %}
                            <div class="episode-row">
                                E#: <input type="number" name="ep_number_{{ outer_loop_index }}_{{ loop.index }}" value="{{ episode.episode_number }}" style="width: 60px;">
                                Title: <input type="text" name="ep_title_{{ outer_loop_index }}_{{ loop.index }}" value="{{ episode.title }}">
                                Rating: <input type="text" name="ep_rating_{{ outer_loop_index }}_{{ loop.index }}" value="{{ episode.rating or '' }}" style="width: 60px;">
                                <button type="button" class="btn-danger" style="margin-left: 10px; padding: 2px 8px;" onclick="removeElement(this, 'episode')">X</button>
                            </div>
                            {% endfor %}
                        </div>
                         <button type="button" onclick="addEpisode(this.parentElement)">+ Add Episode</button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <br>
            <button type="button" class="btn btn-primary" onclick="addSeason()">+ Add Season</button>
        </div>

        <div id="album-fields">
            <h3>Tracks</h3>
            <div id="tracks-container">
                 {% if media and media.media_type == 'album' %}
                    {% for track in media.tracks %}
                    <div class="track-row">
                        T#: <input type="number" name="track_number_{{ loop.index }}" value="{{ track.track_number }}" style="width: 60px;">
                        Title: <input type="text" name="track_title_{{ loop.index }}" value="{{ track.title }}">
                        Rating: <input type="text" name="track_rating_{{ loop.index }}" value="{{ track.rating or '' }}" style="width: 60px;">
                        <button type="button" class="btn-danger" style="margin-left: 10px; padding: 2px 8px;" onclick="removeElement(this, 'track')">X</button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
             <button type="button" onclick="addTrack()">+ Add Track</button>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mediaTypeSelect = document.getElementById('media_type');
            const tvShowFields = document.getElementById('tv-show-fields');
            const albumFields = document.getElementById('album-fields');
            const cinematicTags = document.getElementById('cinematic-tags');
            const musicalTags = document.getElementById('musical-tags');

            function toggleFields() {
                const selectedType = mediaTypeSelect.value;
                tvShowFields.style.display = (selectedType === 'tv_show') ? 'block' : 'none';
                albumFields.style.display = (selectedType === 'album') ? 'block' : 'none';
                
                const isCinematic = (selectedType === 'movie' || selectedType === 'tv_show');
                cinematicTags.style.display = isCinematic ? 'block' : 'none';
                musicalTags.style.display = !isCinematic ? 'block' : 'none';
            }
            mediaTypeSelect.addEventListener('change', toggleFields);
            toggleFields();
        });

        // Counter needs to be high enough to avoid conflict with existing IDs
        let counter = 1000; 

        function addSeason() {
            counter++;
            const container = document.getElementById('seasons-container');
            const newSeason = document.createElement('div');
            newSeason.className = 'season-block';
            newSeason.innerHTML = `
                <div class="season-inputs">
                    Season #: <input type="number" name="season_number_${counter}" value="" style="width: 60px;">
                    Year: <input type="text" name="season_year_${counter}" value="" style="width: 80px;" placeholder="YYYY">
                    Rating: <input type="text" name="season_rating_${counter}" value="" style="width: 60px;" placeholder="0-10">
                    <button type="button" class="btn-danger" style="margin-left: auto; padding: 5px 10px;" onclick="removeElement(this, 'season')">Delete Season</button>
                </div>
                <div class="episodes-container"></div>
                <button type="button" onclick="addEpisode(this.parentElement)">+ Add Episode</button>`;
            container.appendChild(newSeason);
        }

        function addEpisode(seasonBlock) {
            counter++;
            const container = seasonBlock.querySelector('.episodes-container');
            
            // Find the season index ID from the season input name
            const seasonInput = seasonBlock.querySelector('input[name^="season_number_"]');
            const seasonIndex = seasonInput.name.split('_').pop();
            
            // Calculate next episode number for UI niceness
            const episodeCount = container.children.length + 1;
            
            const newEpisode = document.createElement('div');
            newEpisode.className = 'episode-row';
            newEpisode.innerHTML = `
                E#: <input type="number" name="ep_number_${seasonIndex}_${counter}" value="${episodeCount}" style="width: 60px;">
                Title: <input type="text" name="ep_title_${seasonIndex}_${counter}">
                Rating: <input type="text" name="ep_rating_${seasonIndex}_${counter}" style="width: 60px;">
                <button type="button" class="btn-danger" style="margin-left: 10px; padding: 2px 8px;" onclick="removeElement(this, 'episode')">X</button>`;
            container.appendChild(newEpisode);
        }
        
        function addTrack() {
            counter++;
            const container = document.getElementById('tracks-container');
            const trackCount = container.children.length + 1;
            
            const newTrack = document.createElement('div');
            newTrack.className = 'track-row';
            newTrack.innerHTML = `
                T#: <input type="number" name="track_number_${counter}" value="${trackCount}" style="width: 60px;">
                Title: <input type="text" name="track_title_${counter}">
                Rating: <input type="text" name="track_rating_${counter}" style="width: 60px;">
                <button type="button" class="btn-danger" style="margin-left: 10px; padding: 2px 8px;" onclick="removeElement(this, 'track')">X</button>`;
            container.appendChild(newTrack);
        }

        function removeElement(btn, type) {
            if (confirm('Are you sure you want to remove this?')) {
                if (type === 'season') {
                    btn.closest('.season-block').remove();
                } else if (type === 'episode') {
                    btn.closest('.episode-row').remove();
                } else if (type === 'track') {
                    btn.closest('.track-row').remove();
                }
            }
        }
    </script>
{% endblock %}
