{% extends "base.html" %}

{% block title %}{{ 'Edit ' + media.title if media else 'Add New Media' }}{% endblock %}

{% block content %}
    <form method="POST" enctype="multipart/form-data" id="media-form">
        {{ form.hidden_tag() }}
        <h2>{{ 'Edit ' + media.title if media else 'Add New Media' }}</h2>
        
        <div class="form-group">
            {{ form.media_type.label }} {{ form.media_type() }}
        </div>
        <div class="form-group">
            {{ form.title.label }} {{ form.title() }}
        </div>
        
        <div class="form-group">
            <label>Title Word Styling</label>
            <div id="title-styler-container" class="title-styler">
            </div>
            <div id="title_styling_inputs_container"></div>
        </div>
        
        <div class="form-group">
            {{ form.creator.label }} {{ form.creator() }}
        </div>
        <div class="form-group">
            {{ form.years.label }} {{ form.years() }}
        </div>
        <div class="form-group">
            {{ form.poster_img.label }} {{ form.poster_img() }}
        </div>
        <div class="form-group">
            {{ form.banner_img.label }} {{ form.banner_img() }}
        </div>
        <div class="form-group">
            {{ form.official_rating.label }} {{ form.official_rating() }}
        </div>

        <hr>

        <div id="tv-show-fields">
            <h3>Seasons & Episodes</h3>
            <div id="seasons-container">
                {% if media and media.media_type == 'tv_show' %}
                    {% for season in media.seasons %}
                    <div class="season-block" style="background: #333; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
                        Season #: <input type="number" name="season_number_{{ loop.index }}" value="{{ season.season_number }}">
                        <div class="episodes-container">
                            {% for episode in season.episodes %}
                            <div class="episode-row" style="display: flex; gap: 5px; margin-top: 5px;">
                                E#: <input type="number" name="ep_number_{{ loop.parent.loop.index }}_{{ loop.index }}" value="{{ episode.episode_number }}" style="width: 60px;">
                                Title: <input type="text" name="ep_title_{{ loop.parent.loop.index }}_{{ loop.index }}" value="{{ episode.title }}">
                                Rating: <input type="text" name="ep_rating_{{ loop.parent.loop.index }}_{{ loop.index }}" value="{{ episode.rating or '' }}" style="width: 60px;">
                            </div>
                            {% endfor %}
                        </div>
                         <button type="button" onclick="addEpisode(this.parentElement)">+ Add Episode</button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <button type="button" onclick="addSeason()">+ Add Season</button>
        </div>

        <div id="album-fields">
            <h3>Tracks</h3>
            <div id="tracks-container">
                 {% if media and media.media_type == 'album' %}
                    {% for track in media.tracks %}
                    <div class="track-row" style="display: flex; gap: 5px; margin-top: 5px;">
                        T#: <input type="number" name="track_number_{{ loop.index }}" value="{{ track.track_number }}" style="width: 60px;">
                        Title: <input type="text" name="track_title_{{ loop.index }}" value="{{ track.title }}">
                        Rating: <input type="text" name="track_rating_{{ loop.index }}" value="{{ track.rating or '' }}" style="width: 60px;">
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
             <button type="button" onclick="addTrack()">+ Add Track</button>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mediaTypeSelect = document.getElementById('media_type');
            const tvShowFields = document.getElementById('tv-show-fields');
            const albumFields = document.getElementById('album-fields');

            function toggleFields() {
                const selectedType = mediaTypeSelect.value;
                tvShowFields.style.display = (selectedType === 'tv_show') ? 'block' : 'none';
                albumFields.style.display = (selectedType === 'album') ? 'block' : 'none';
            }
            mediaTypeSelect.addEventListener('change', toggleFields);
            toggleFields();

            const titleInput = document.getElementById('title');
            const stylerContainer = document.getElementById('title-styler-container');
            const hiddenInputsContainer = document.getElementById('title_styling_inputs_container');

            // --- THIS IS THE CORRECTED LINE ---
            // Changed from 'to_dict' to 'to_dict()'
            let existingStyling = {{ media.title_styles|map(attribute='to_dict()')|list|tojson if media and media.title_styles else '[]' }};

            function updateTitleStyler() {
                const titleText = titleInput.value;
                const tokens = titleText.split(/\s+/).filter(t => t.length > 0);
                
                stylerContainer.innerHTML = ''; 
                hiddenInputsContainer.innerHTML = '';

                tokens.forEach((token, index) => {
                    // Match by index first for stability when words are repeated
                    const existingTokenStyle = existingStyling.find(s => s.token_index === index);
                    const color1 = existingTokenStyle ? existingTokenStyle.color1 : '#000000';
                    const color2 = existingTokenStyle ? (existingTokenStyle.color2 || '#000000') : '#000000';

                    const stylerRow = document.createElement('div');
                    stylerRow.className = 'styler-row';
                    stylerRow.innerHTML = `
                        <span class="styler-token">${token}</span>
                        <div class="styler-inputs">
                            <label>Color 1: <input type="color" data-index="${index}" class="color-1" value="${color1}"></label>
                            <label>Color 2 (Gradient): <input type="color" data-index="${index}" class="color-2" value="${color2}"></label>
                            <button type="button" class="btn-reset">Reset</button>
                        </div>
                    `;
                    stylerContainer.appendChild(stylerRow);

                    hiddenInputsContainer.innerHTML += `
                        <input type="hidden" name="token_${index}" value="${token}">
                        <input type="hidden" name="color1_${index}" id="form_color1_${index}" value="${color1}">
                        <input type="hidden" name="color2_${index}" id="form_color2_${index}" value="${color2}">
                    `;
                });

                stylerContainer.querySelectorAll('input[type="color"]').forEach(picker => {
                    picker.addEventListener('input', function() {
                        const index = this.dataset.index;
                        const targetId = this.classList.contains('color-1') ? `form_color1_${index}` : `form_color2_${index}`;
                        document.getElementById(targetId).value = this.value;
                    });
                });

                stylerContainer.querySelectorAll('.btn-reset').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const inputs = this.parentElement.querySelectorAll('input[type="color"]');
                        inputs[0].value = '#000000';
                        inputs[1].value = '#000000';
                        inputs[0].dispatchEvent(new Event('input'));
                        inputs[1].dispatchEvent(new Event('input'));
                    });
                });
            }
            
            titleInput.addEventListener('keyup', updateTitleStyler);
            updateTitleStyler();
        });

        // --- Other dynamic add/remove logic ---
        let seasonCount = {{ media.seasons|length if media and media.media_type == 'tv_show' else 0 }};
        function addSeason() {}
        function addEpisode(seasonBlock) {}
        let trackCount = {{ media.tracks|length if media and media.media_type == 'album' else 0 }};
        function addTrack() {}
    </script>
{% endblock %}
